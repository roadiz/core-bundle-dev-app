class u extends HTMLElement{get nodeId(){return this.getAttribute("data-node-id")?parseInt(this.getAttribute("data-node-id")):null}get contextualMenuPath(){return this.getAttribute("data-contextual-menu-path")}get editPositionPath(){return this.getAttribute("data-node-edit-position-path")}get duplicatePath(){return this.getAttribute("data-node-duplicate-path")}get pastePath(){return this.getAttribute("data-node-paste-path")}get statusPath(){return this.getAttribute("data-node-status-path")}get copiedTrans(){return this.getAttribute("data-node-copied-trans")}get copiedNodeId(){return window.sessionStorage.getItem("rozier_copied_node_id")?parseInt(window.sessionStorage.getItem("rozier_copied_node_id")):null}connectedCallback(){const e=this.querySelector(".tree-contextualmenu-button"),t=this.contextualMenuPath;!e||!t||(this.onClick=this.onClick.bind(this),this.moveNodeToPosition=this.moveNodeToPosition.bind(this),e.addEventListener("click",async()=>{if(!this.querySelector("nav.uk-dropdown")){window.dispatchEvent(new CustomEvent("requestLoaderShow"));const i=await fetch(t,{headers:{"X-Requested-With":"XMLHttpRequest"}});this.insertAdjacentHTML("beforeend",await i.text()),window.dispatchEvent(new CustomEvent("requestLoaderHide"))}this.querySelectorAll(".paste-node").forEach(i=>{i&&!Number.isInteger(this.copiedNodeId)&&i.setAttribute("disabled","disabled"),i&&Number.isInteger(this.copiedNodeId)&&(i.removeAttribute("disabled"),i.removeEventListener("click",this.onClick),i.addEventListener("click",this.onClick))});const o=this.querySelector(".copy-node");o&&(o.removeEventListener("click",this.onClick),o.addEventListener("click",this.onClick)),this.querySelectorAll(".node-actions a, .node-actions button, .duplicate-node").forEach(i=>{i.removeEventListener("click",this.onClick),i.addEventListener("click",this.onClick)});const a=this.querySelector(".move-node-first-position");a&&a.addEventListener("click",i=>this.moveNodeToPosition("first",i));const d=this.querySelector(".move-node-last-position");d&&d.addEventListener("click",i=>this.moveNodeToPosition("last",i))}))}async onClick(e){e.preventDefault();const t=e.currentTarget,n=t.getAttribute("data-status"),s=t.getAttribute("data-value"),o=t.getAttribute("data-action");if(window.dispatchEvent(new CustomEvent("requestLoaderShow")),o==="duplicate"){await this.duplicateNode();return}if(o==="copy"){this.copyNode();return}if(o==="paste_inside"){await this.pasteInsideNode();return}if(o==="paste_after"){await this.pasteAfterNode();return}if(n!==""&&s!==""){await this.changeStatus(n,s);return}}async changeStatus(e,t){try{await this.postNodeUpdate(this.statusPath,{csrfToken:window.RozierConfig.ajaxToken,nodeId:this.nodeId,statusName:e,statusValue:t})}finally{window.dispatchEvent(new CustomEvent("requestLoaderHide"))}}copyNode(){window.sessionStorage.setItem("rozier_copied_node_id",this.nodeId.toString()),window.dispatchEvent(new CustomEvent("pushToast",{detail:{message:this.copiedTrans||"Node copied to clipboard",status:"success"}})),window.dispatchEvent(new CustomEvent("requestLoaderHide"))}async pasteInsideNode(){await this.pasteNode("parentNodeId")}async pasteAfterNode(){await this.pasteNode("prevNodeId")}async pasteNode(e="parentNodeId"){if(!Number.isSafeInteger(this.copiedNodeId)||!Number.isSafeInteger(this.nodeId))return;const t={csrfToken:window.RozierConfig.ajaxToken,nodeId:this.copiedNodeId};t[e]=this.nodeId;try{await this.postNodeUpdate(this.pastePath,t),window.sessionStorage.removeItem("rozier_copied_node_id")}finally{window.dispatchEvent(new CustomEvent("requestLoaderHide"))}}async duplicateNode(){if(Number.isSafeInteger(this.nodeId))try{await this.postNodeUpdate(this.duplicatePath,{csrfToken:window.RozierConfig.ajaxToken,nodeId:this.nodeId})}finally{window.dispatchEvent(new CustomEvent("requestLoaderHide"))}}async moveNodeToPosition(e,t){if(!Number.isSafeInteger(this.nodeId))return;window.dispatchEvent(new CustomEvent("requestLoaderShow"));let n=t.currentTarget.closest(".nodetree-element"),s=parseInt(n.closest("ul").getAttribute("data-parent-node-id")),o={csrfToken:window.RozierConfig.ajaxToken,id:this.nodeId};typeof e<"u"&&e==="first"?o.firstPosition=!0:typeof e<"u"&&e==="last"&&(o.lastPosition=!0),isNaN(s)&&(s=null),o.newParentId=s;try{await this.postNodeUpdate(this.editPositionPath,o)}finally{window.dispatchEvent(new CustomEvent("requestLoaderHide"))}}async postNodeUpdate(e,t){try{const n=await fetch(e,{method:"POST",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:new URLSearchParams(t)});if(n.ok){const s=await n.json();return window.dispatchEvent(new CustomEvent("requestAllNodeTreeChange")),s}else{const s=await n.json();throw window.dispatchEvent(new CustomEvent("pushToast",{detail:{message:s.error_message,status:"danger"}})),s}}catch(n){window.dispatchEvent(new CustomEvent("pushToast",{detail:{message:n.detail||n.message||"postNodeUpdate: Unknown error",status:"danger"}}))}}}export{u as default};
