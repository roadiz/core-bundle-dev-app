class r extends HTMLElement{get contextualMenuPath(){return this.getAttribute("data-contextual-menu-path")}get editPath(){return this.getAttribute("data-node-edit-path")}get statusPath(){return this.getAttribute("data-node-status-path")}connectedCallback(){const t=this.querySelector(".tree-contextualmenu-button"),n=this.contextualMenuPath;!t||!n||(this.onClick=this.onClick.bind(this),this.moveNodeToPosition=this.moveNodeToPosition.bind(this),t.addEventListener("click",async()=>{if(!this.querySelector("nav.uk-dropdown")){window.dispatchEvent(new CustomEvent("requestLoaderShow"));const s=await fetch(n,{headers:{"X-Requested-With":"XMLHttpRequest"}});this.insertAdjacentHTML("beforeend",await s.text()),window.dispatchEvent(new CustomEvent("requestLoaderHide"))}const o=this.querySelectorAll(".node-actions a, .node-actions button, .duplicate-node"),i=this.querySelector(".move-node-first-position"),a=this.querySelector(".move-node-last-position");o.forEach(s=>{s.removeEventListener("click",this.onClick),s.addEventListener("click",this.onClick)}),i&&i.addEventListener("click",s=>this.moveNodeToPosition("first",s)),a&&a.addEventListener("click",s=>this.moveNodeToPosition("last",s))}))}async onClick(t){t.preventDefault();const n=t.currentTarget,e=n.closest(".nodetree-element"),o=parseInt(e.getAttribute("data-node-id")),i=n.getAttribute("data-status"),a=n.getAttribute("data-value"),s=n.getAttribute("data-action");if(window.dispatchEvent(new CustomEvent("requestLoaderShow")),s==="duplicate"){await this.duplicateNode(o);return}if(i!==""&&a!==""){await this.changeStatus(o,i,a);return}}async changeStatus(t,n,e){try{await this.postNodeUpdate(this.statusPath,{_token:window.RozierConfig.ajaxToken,_action:"nodeChangeStatus",nodeId:t,statusName:n,statusValue:e})}finally{window.dispatchEvent(new CustomEvent("requestLoaderHide"))}}async duplicateNode(t){try{await this.postNodeUpdate(this.editPath,{_token:window.RozierConfig.ajaxToken,_action:"duplicate",nodeId:t})}finally{window.dispatchEvent(new CustomEvent("requestLoaderHide"))}}async moveNodeToPosition(t,n){window.dispatchEvent(new CustomEvent("requestLoaderShow"));let e=n.currentTarget.closest(".nodetree-element"),o=parseInt(e.getAttribute("data-node-id")),i=parseInt(e.closest("ul").getAttribute("data-parent-node-id")),a={_token:window.RozierConfig.ajaxToken,_action:"updatePosition",nodeId:o};typeof t<"u"&&t==="first"?a.firstPosition=!0:typeof t<"u"&&t==="last"&&(a.lastPosition=!0),isNaN(i)&&(i=null),a.newParent=i;try{await this.postNodeUpdate(this.editPath,a)}finally{window.dispatchEvent(new CustomEvent("requestLoaderHide"))}}async postNodeUpdate(t,n){try{const e=await fetch(t,{method:"POST",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:new URLSearchParams(n)});if(e.ok){const o=await e.json();return window.dispatchEvent(new CustomEvent("requestAllNodeTreeChange")),o}else{const o=await e.json();throw window.dispatchEvent(new CustomEvent("pushToast",{detail:{message:o.error_message,status:"danger"}})),o}}catch(e){window.dispatchEvent(new CustomEvent("pushToast",{detail:{message:e.detail||e.message||"postNodeUpdate: Unknown error",status:"danger"}}))}}}export{r as default};
