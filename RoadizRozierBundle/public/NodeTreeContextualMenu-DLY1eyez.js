class u extends HTMLElement{get contextualMenuPath(){return this.getAttribute("data-contextual-menu-path")}get editPath(){return this.getAttribute("data-node-edit-path")}get statusPath(){return this.getAttribute("data-node-status-path")}connectedCallback(){const t=this.querySelector(".tree-contextualmenu-button"),o=this.contextualMenuPath;!t||!o||(this.onClick=this.onClick.bind(this),this.moveNodeToPosition=this.moveNodeToPosition.bind(this),t.addEventListener("click",async a=>{if(!this.querySelector("nav.uk-dropdown")){window.dispatchEvent(new CustomEvent("requestLoaderShow"));const i=await fetch(o,{headers:{"X-Requested-With":"XMLHttpRequest"}});this.insertAdjacentHTML("beforeend",await i.text()),window.dispatchEvent(new CustomEvent("requestLoaderHide"))}const n=this.querySelectorAll(".node-actions a, .node-actions button, .duplicate-node"),e=this.querySelector(".move-node-first-position"),d=this.querySelector(".move-node-last-position");n.forEach(i=>{i.removeEventListener("click",this.onClick),i.addEventListener("click",this.onClick)}),e&&e.addEventListener("click",i=>this.moveNodeToPosition("first",i)),d&&d.addEventListener("click",i=>this.moveNodeToPosition("last",i))}))}async onClick(t){t.preventDefault();const o=t.currentTarget,a=o.closest(".nodetree-element"),s=parseInt(a.getAttribute("data-node-id")),n=o.getAttribute("data-status"),e=o.getAttribute("data-value"),d=o.getAttribute("data-action");if(window.dispatchEvent(new CustomEvent("requestLoaderShow")),d==="duplicate"){await this.duplicateNode(s);return}if(n!==""&&e!==""){await this.changeStatus(s,n,e);return}}async changeStatus(t,o,a){await this.postNodeUpdate(this.statusPath,{_token:window.RozierConfig.ajaxToken,_action:"nodeChangeStatus",nodeId:t,statusName:o,statusValue:a}),window.dispatchEvent(new CustomEvent("requestLoaderHide"))}async duplicateNode(t){await this.postNodeUpdate(this.editPath,{_token:window.RozierConfig.ajaxToken,_action:"duplicate",nodeId:t}),window.dispatchEvent(new CustomEvent("requestLoaderHide"))}async moveNodeToPosition(t,o){window.dispatchEvent(new CustomEvent("requestLoaderShow"));let a=o.currentTarget.closest(".nodetree-element"),s=parseInt(a.getAttribute("data-node-id")),n=parseInt(a.closest("ul").getAttribute("data-parent-node-id")),e={_token:window.RozierConfig.ajaxToken,_action:"updatePosition",nodeId:s};typeof t<"u"&&t==="first"?e.firstPosition=!0:typeof t<"u"&&t==="last"&&(e.lastPosition=!0),isNaN(n)&&(n=null),e.newParent=n,await this.postNodeUpdate(this.editPath,e),window.dispatchEvent(new CustomEvent("requestLoaderHide"))}async postNodeUpdate(t,o){return new Promise(async(a,s)=>{try{const n=await fetch(t,{method:"POST",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:new URLSearchParams(o)});if(n.ok){const e=await n.json();window.dispatchEvent(new CustomEvent("requestAllNodeTreeChange")),a(e)}else{const e=await n.json();window.dispatchEvent(new CustomEvent("pushToast",{detail:{message:e.error_message,status:"danger"}})),s(e)}}catch(n){s(n)}})}}export{u as default};
